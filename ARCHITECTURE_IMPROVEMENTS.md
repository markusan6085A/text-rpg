# üèóÔ∏è –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö

## ‚úÖ –©–æ –±—É–ª–æ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ

### 1. ‚úÖ Optimistic Locking (Revision Control)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –ø—Ä–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö –æ–Ω–æ–≤–ª–µ–Ω–Ω—è—Ö (–¥–≤—ñ –≤–∫–ª–∞–¥–∫–∏, –º–æ–±—ñ–ª—å–Ω–∏–π + –ü–ö).

**–†—ñ—à–µ–Ω–Ω—è:**
- –î–æ–¥–∞–Ω–æ `heroRevision` (timestamp) –≤ `heroJson` –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –≤–µ—Ä—Å—ñ—ó
- –ö–ª—ñ—î–Ω—Ç –ø–µ—Ä–µ–¥–∞—î `expectedRevision` –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ
- Backend –ø–µ—Ä–µ–≤—ñ—Ä—è—î –∑–±—ñ–≥ —Ä–µ–≤—ñ–∑—ñ–π, –ø–æ–≤–µ—Ä—Ç–∞—î `409 Conflict` –ø—Ä–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ
- –ö–ª—ñ—î–Ω—Ç –æ–±—Ä–æ–±–ª—è—î –∫–æ–Ω—Ñ–ª—ñ–∫—Ç —ñ –º–æ–∂–µ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ

**–§–∞–π–ª–∏:**
- `server/src/heroJsonValidator.ts` - –≤–∞–ª—ñ–¥–∞—Ü—ñ—è —Ç–∞ versioning
- `server/src/characters.ts` - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ–≤—ñ–∑—ñ—ó –≤ PUT endpoint
- `src/state/heroStore/heroPersistence.ts` - –ø–µ—Ä–µ–¥–∞—á–∞ expectedRevision
- `src/utils/api.ts` - –æ–±—Ä–æ–±–∫–∞ 409 –ø–æ–º–∏–ª–∫–∏

### 2. ‚úÖ –í–∞–ª—ñ–¥–∞—Ü—ñ—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ heroJson

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –∂–æ—Ä—Å—Ç–∫–æ—ó —Å—Ö–µ–º–∏ ‚Üí —Ä–∏–∑–∏–∫ "–ø–ª–∞–≤–∞—é—á–∏—Ö" —Ñ–æ—Ä–º–∞—Ç—ñ–≤.

**–†—ñ—à–µ–Ω–Ω—è:**
- –î–æ–¥–∞–Ω–æ `validateHeroJson()` –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –Ω–∞ backend
- –ü–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å—Å—è –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è (name, race, classId)
- –ü–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å—Å—è —Ç–∏–ø–∏ (level, exp, inventory, skills, —Ç–æ—â–æ)
- –ü–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –¥–µ—Ç–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–º–∏–ª–æ–∫ –ø—Ä–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó

**–§–∞–π–ª–∏:**
- `server/src/heroJsonValidator.ts` - —Ñ—É–Ω–∫—Ü—ñ—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó

### 3. ‚úÖ Versioning heroJson

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–º–∞—î –≤–µ—Ä—Å—ñ–æ–Ω—É–≤–∞–Ω–Ω—è —Å—Ö–µ–º–∏ ‚Üí –≤–∞–∂–∫–æ –º—ñ–≥—Ä—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ.

**–†—ñ—à–µ–Ω–Ω—è:**
- –î–æ–¥–∞–Ω–æ `heroJsonVersion` –≤ `heroJson` (–ø–æ—Ç–æ—á–Ω–∞ –≤–µ—Ä—Å—ñ—è: 1)
- –ü—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ–¥–∞—î—Ç—å—Å—è/–æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≤–µ—Ä—Å—ñ—è
- –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—ó "–Ω–∞ –ª—å–æ—Ç—É" –ø—Ä–∏ –∑–º—ñ–Ω—ñ –≤–µ—Ä—Å—ñ—ó

**–§–∞–π–ª–∏:**
- `server/src/heroJsonValidator.ts` - —Ñ—É–Ω–∫—Ü—ñ—è `addVersioning()`

### 4. ‚úÖ –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è lastActivityAt

**–ü—Ä–æ–±–ª–µ–º–∞:** `lastActivityAt` –æ–Ω–æ–≤–ª—é–≤–∞–≤—Å—è –Ω–∞ –∫–æ–∂–Ω–æ–º—É PUT ‚Üí –∑–∞–π–≤–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.

**–†—ñ—à–µ–Ω–Ω—è:**
- `lastActivityAt` –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –¢–Ü–õ–¨–ö–ò –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ `heroJson` (–æ—Å–Ω–æ–≤–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å)
- –î–ª—è —ñ–Ω—à–∏—Ö –ø–æ–ª—ñ–≤ (level, exp, —Ç–æ—â–æ) –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è —á–µ—Ä–µ–∑ `/characters/heartbeat`
- –ó–º–µ–Ω—à–µ–Ω–æ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ –ë–î

**–§–∞–π–ª–∏:**
- `server/src/characters.ts` - —É–º–æ–≤–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è lastActivityAt

### 5. ‚úÖ Rate Limiting

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–º–∞—î –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ —Å–ø–∞–º—É/–∞—Ç–∞–∫.

**–†—ñ—à–µ–Ω–Ω—è:**
- –î–æ–¥–∞–Ω–æ –ø—Ä–æ—Å—Ç–∏–π rate limiter –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö endpoints
- –û–±–º–µ–∂–µ–Ω–Ω—è:
  - `/auth/login` - 5 —Å–ø—Ä–æ–±/—Ö–≤–∏–ª–∏–Ω—É
  - `/auth/register` - 3 —Å–ø—Ä–æ–±–∏/—Ö–≤–∏–ª–∏–Ω—É
  - `/chat/messages` - 10 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å/—Ö–≤–∏–ª–∏–Ω—É
  - `/letters` - 5 –ª–∏—Å—Ç—ñ–≤/—Ö–≤–∏–ª–∏–Ω—É
  - `/characters/:id` (PUT) - 30 –æ–Ω–æ–≤–ª–µ–Ω—å/—Ö–≤–∏–ª–∏–Ω—É
- Rate limiting –ø–æ IP –∞–±–æ accountId (—è–∫—â–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–π)
- –ü–æ–≤–µ—Ä—Ç–∞—î 429 Too Many Requests –∑ headers X-RateLimit-*

**–§–∞–π–ª–∏:**
- `server/src/rateLimiter.ts` - —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è rate limiter
- `server/src/auth.ts` - rate limiting –¥–ª—è auth endpoints
- `server/src/chat.ts` - rate limiting –¥–ª—è chat
- `server/src/letters.ts` - rate limiting –¥–ª—è letters
- `server/src/characters.ts` - rate limiting –¥–ª—è character updates

### 6. ‚úÖ –ü–æ–ª—ñ—Ç–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó localStorage ‚Üî server

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–º–∞—î —á—ñ—Ç–∫–æ—ó –ø–æ–ª—ñ—Ç–∏–∫–∏, —Ö—Ç–æ –Ω–æ–≤—ñ—à–∏–π –ø—Ä–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ.

**–†—ñ—à–µ–Ω–Ω—è:**
- –î–æ–¥–∞–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –≥–µ—Ä–æ—è
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è `heroRevision` (–Ω–∞–π—Ç–æ—á–Ω—ñ—à–∏–π) –∞–±–æ `updatedAt` (fallback)
- –Ø–∫—â–æ server –Ω–æ–≤—ñ—à–∏–π - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è server –≤–µ—Ä—Å—ñ—è
- –Ø–∫—â–æ local –Ω–æ–≤—ñ—à–∏–π - –ª–æ–≥—É—î—Ç—å—Å—è –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è, –∞–ª–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è server –¥–ª—è –±–µ–∑–ø–µ–∫–∏
- –î–æ–¥–∞–Ω–æ `lastSavedAt` –≤ localStorage –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è —á–∞—Å—É –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è

**–§–∞–π–ª–∏:**
- `src/state/heroStore/syncPolicy.ts` - –ø–æ–ª—ñ—Ç–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
- `src/state/heroStore/heroLoadAPI.ts` - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
- `src/state/heroStore/heroPersistence.ts` - –¥–æ–¥–∞–≤–∞–Ω–Ω—è lastSavedAt –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ

<hr style="border: none; border-top: 2px dotted #C9B36B; margin: 20px 0;">

## üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –¥–ª—è –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ

### 1. ‚ö†Ô∏è InventoryItem —Ç–∞–±–ª–∏—Ü—è

**–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω:** –¢–∞–±–ª–∏—Ü—è `InventoryItem` —ñ—Å–Ω—É—î –≤ —Å—Ö–µ–º—ñ, –∞–ª–µ –ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ –∫–æ–¥—ñ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
- **–í–∞—Ä—ñ–∞–Ω—Ç –ê (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ):** –í–∏–¥–∞–ª–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é `InventoryItem` –∑—ñ —Å—Ö–µ–º–∏, —è–∫—â–æ –Ω–µ –ø–ª–∞–Ω—É—î—Ç—å—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
- **–í–∞—Ä—ñ–∞–Ω—Ç –ë:** –Ø–∫—â–æ –ø–ª–∞–Ω—É—î—Ç—å—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è - —á—ñ—Ç–∫–æ –≤–∏–∑–Ω–∞—á–∏—Ç–∏:
  - `InventoryItem` = –¥–∂–µ—Ä–µ–ª–æ —ñ—Å—Ç–∏–Ω–∏
  - `heroJson.inventory` = –∫–µ—à/UI-—Å—Ç–∞–Ω
  - –î–æ–¥–∞—Ç–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é –º—ñ–∂ –Ω–∏–º–∏

**–î–∂–µ—Ä–µ–ª–æ —ñ—Å—Ç–∏–Ω–∏ –∑–∞—Ä–∞–∑:** `heroJson.inventory` ‚úÖ

### 2. ‚ö†Ô∏è Rate Limiting

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–º–∞—î –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ —Å–ø–∞–º—É/–∞—Ç–∞–∫.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
- –î–æ–¥–∞—Ç–∏ rate limiting –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö endpoints:
  - `/auth/login` - 5 —Å–ø—Ä–æ–±/—Ö–≤–∏–ª–∏–Ω—É
  - `/auth/register` - 3 —Å–ø—Ä–æ–±–∏/—Ö–≤–∏–ª–∏–Ω—É
  - `/chat/messages` - 10 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å/—Ö–≤–∏–ª–∏–Ω—É
  - `/letters` - 5 –ª–∏—Å—Ç—ñ–≤/—Ö–≤–∏–ª–∏–Ω—É
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ `@fastify/rate-limit` –∞–±–æ `express-rate-limit`

### 3. ‚ö†Ô∏è –ü–æ–ª—ñ—Ç–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó localStorage ‚Üî server

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–º–∞—î —á—ñ—Ç–∫–æ—ó –ø–æ–ª—ñ—Ç–∏–∫–∏, —Ö—Ç–æ –Ω–æ–≤—ñ—à–∏–π –ø—Ä–∏ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
- –î–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É `updatedAt` –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –∑ localStorage
- –Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä –Ω–æ–≤—ñ—à–∏–π ‚Üí –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –∑ —Å–µ—Ä–≤–µ—Ä–∞
- –Ø–∫—â–æ localStorage –Ω–æ–≤—ñ—à–∏–π ‚Üí –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `heroRevision` –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –Ω–æ–≤—ñ—à–æ—ó –≤–µ—Ä—Å—ñ—ó

### 4. ‚ö†Ô∏è –í–∏–Ω–µ—Å–µ–Ω–Ω—è –ø–æ–ª—ñ–≤ –≤ –æ–∫—Ä–µ–º—ñ –∫–æ–ª–æ–Ω–∫–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:** –í–∏–Ω–µ—Å—Ç–∏ –≤ –æ–∫—Ä–µ–º—ñ –∫–æ–ª–æ–Ω–∫–∏ –≤—Å–µ, —â–æ —á–∞—Å—Ç–æ —Ñ—ñ–ª—å—Ç—Ä—É—î—Ç—å—Å—è/—Å–æ—Ä—Ç—É—î—Ç—å—Å—è:

- ‚úÖ `level`, `classId`, `race`, `name` - –≤–∂–µ —î
- ‚úÖ `nickColor` - –≤–∂–µ —î
- ‚ö†Ô∏è `locationId` - —è–∫—â–æ –ø–ª–∞–Ω—É—é—Ç—å—Å—è —Ä–µ–π—Ç–∏–Ω–≥–∏/–æ–Ω–ª–∞–π–Ω –ø–æ –ª–æ–∫–∞—Ü—ñ—è—Ö
- ‚ö†Ô∏è `power` - —è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ —Ç–æ–ø–∞—Ö

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- –®–≤–∏–¥—à—ñ –∑–∞–ø–∏—Ç–∏ –±–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥—É JSON
- –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å —ñ–Ω–¥–µ–∫—Å—ñ–≤ –¥–ª—è —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
- –ú–µ–Ω—à–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ –ë–î

### 5. ‚ö†Ô∏è –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ scheduled jobs

**–ü–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω:** –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ `setInterval` –≤ `server/src/index.ts`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ Supabase Cron Jobs –∞–±–æ –æ–∫—Ä–µ–º–∏–π worker
- –ê–±–æ PostgreSQL scheduled functions
- –¶–µ –∑–º–µ–Ω—à–∏—Ç—å –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω–∏–π –ø—Ä–æ—Ü–µ—Å

### 6. ‚ö†Ô∏è –ö–æ–º–ø—Ä–µ—Å—ñ—è localStorage

**–ü—Ä–æ–±–ª–µ–º–∞:** `heroJson` –º–æ–∂–µ –±—É—Ç–∏ –≤–µ–ª–∏–∫–∏–º ‚Üí —Ä–∏–∑–∏–∫ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–Ω—è localStorage.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
- –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ `lz-string` –¥–ª—è –∫–æ–º–ø—Ä–µ—Å—ñ—ó –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –≤ localStorage
- –û–±–º–µ–∂–∏—Ç–∏ —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø–∏—Å—É (debounce/throttle)
- –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –∫—Ä–∏—Ç–∏—á–Ω—ñ –¥–∞–Ω—ñ, –Ω–µ –≤–µ—Å—å `heroJson`

### 7. ‚ö†Ô∏è –ú—ñ–≥—Ä–∞—Ü—ñ—ó heroJson "–Ω–∞ –ª—å–æ—Ç—É"

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:**
- –î–æ–¥–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é –º—ñ–≥—Ä–∞—Ü—ñ—ó –ø—Ä–∏ –∑–º—ñ–Ω—ñ `heroJsonVersion`
- –ü—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –≥–µ—Ä–æ—è –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –≤–µ—Ä—Å—ñ—é
- –Ø–∫—â–æ –≤–µ—Ä—Å—ñ—è —Å—Ç–∞—Ä—ñ—à–∞ - –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
- –ü—Ä–∏–∫–ª–∞–¥: `migrateHeroJson(heroJson, fromVersion, toVersion)`

<hr style="border: none; border-top: 2px dotted #C9B36B; margin: 20px 0;">

## üéØ –ü—ñ–¥—Å—É–º–æ–∫

### ‚úÖ –©–æ –ø—Ä–∞—Ü—é—î –¥–æ–±—Ä–µ:
1. **heroJson —è–∫ aggregate** - —à–≤–∏–¥–∫–æ —Ä–æ–∑–≤–∏–≤–∞—Ç–∏, –ª–µ–≥–∫–æ —Ä–æ–±–∏—Ç–∏ –±–µ–∫–∞–ø–∏
2. **–û–¥–∏–Ω source of truth** - `heroJson.inventory` (–Ω–µ InventoryItem)
3. **Backup –≤ localStorage** - –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –≤—Ç—Ä–∞—Ç–∏ –¥–∞–Ω–∏—Ö
4. **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞** - —á–∞—Ç 24 –≥–æ–¥, –ª–∏—Å—Ç–∏ 30 –¥–Ω—ñ–≤

### ‚úÖ –©–æ –±—É–ª–æ –ø–æ–∫—Ä–∞—â–µ–Ω–æ:
1. **Optimistic locking** - –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ ‚úÖ
2. **–í–∞–ª—ñ–¥–∞—Ü—ñ—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏** - –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –∑–ª–∞–º–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö ‚úÖ
3. **Versioning** - –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –º—ñ–≥—Ä–∞—Ü—ñ–π ‚úÖ
4. **–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è lastActivityAt** - –º–µ–Ω—à–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ‚úÖ
5. **Rate limiting** - –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ —Å–ø–∞–º—É —Ç–∞ –∞—Ç–∞–∫ ‚úÖ
6. **–ü–æ–ª—ñ—Ç–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó** - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ localStorage ‚Üî server ‚úÖ

### ‚ö†Ô∏è –û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è (–Ω–∞ –º–∞–π–±—É—Ç–Ω—î):
1. **–í–∏–Ω–µ—Å–µ–Ω–Ω—è –ø–æ–ª—ñ–≤** - locationId, power (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
2. **–ö–æ–º–ø—Ä–µ—Å—ñ—è localStorage** - –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è —Ä–æ–∑–º—ñ—Ä—É (lz-string)
3. **–ú—ñ–≥—Ä–∞—Ü—ñ—ó "–Ω–∞ –ª—å–æ—Ç—É"** - –¥–ª—è –∑–º—ñ–Ω–∏ –≤–µ—Ä—Å—ñ–π heroJson
4. **Scheduled jobs** - –¥–ª—è –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏ (–∑–∞–º—ñ—Å—Ç—å setInterval)

<hr style="border: none; border-top: 2px dotted #C9B36B; margin: 20px 0;">

## üìù –ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è optimistic locking

```typescript
// –ö–ª—ñ—î–Ω—Ç –æ—Ç—Ä–∏–º—É—î –≥–µ—Ä–æ—è –∑ —Ä–µ–≤—ñ–∑—ñ—î—é
const character = await getCharacter(id);
const hero = character.heroJson;
const currentRevision = hero.heroRevision; // –∑–±–µ—Ä—ñ–≥–∞—î–º–æ

// –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ä–æ–±–∏—Ç—å –∑–º—ñ–Ω–∏
hero.adena += 100;

// –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∑ –æ—á—ñ–∫—É–≤–∞–Ω–æ—é —Ä–µ–≤—ñ–∑—ñ—î—é
try {
  await updateCharacter(id, {
    heroJson: hero,
    expectedRevision: currentRevision, // –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É
  });
} catch (error) {
  if (error.status === 409) {
    // –ö–æ–Ω—Ñ–ª—ñ–∫—Ç! –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ
    alert('Character was modified. Reloading...');
    window.location.reload();
  }
}
```

<hr style="border: none; border-top: 2px dotted #C9B36B; margin: 20px 0;">

**–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è:** 2025-01-19
**–í–µ—Ä—Å—ñ—è heroJson:** 1
