# üìã –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è –ø–æ–ª—ñ—Ç–∏–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó —Ç–∞ optimistic locking

## üîí Optimistic Locking (Revision Control)

### –ö–æ–Ω—Ç—Ä–∞–∫—Ç

**–ö–ª—ñ—î–Ω—Ç:**
- –ü—Ä–∏ PUT `/characters/:id` –∑–∞–≤–∂–¥–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î `expectedRevision` (–ø–æ—Ç–æ—á–Ω—É —Ä–µ–≤—ñ–∑—ñ—é –∑ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è)
- –Ø–∫—â–æ `expectedRevision` –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ - –¥–æ–∑–≤–æ–ª—è—î—Ç—å—Å—è (backward compatibility)

**–°–µ—Ä–≤–µ—Ä:**
1. –ü–æ—Ä—ñ–≤–Ω—é—î `expectedRevision` –∑ `heroRevision` –≤ –ë–î
2. –ü—Ä–∏ –Ω–µ–≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ ‚Üí **409 Conflict** –∑ —Å–µ—Ä–≤–µ—Ä–Ω–∏–º state:
   ```json
   {
     "error": "revision_conflict",
     "message": "Character was modified by another session. Please reload and try again.",
     "currentRevision": 1234567890,
     "updatedAt": "2025-01-19T12:00:00.000Z",
     "serverState": {
       "heroRevision": 1234567890,
       "heroJsonVersion": 1,
       "updatedAt": "2025-01-19T12:00:00.000Z"
     }
   }
   ```
3. –ü—Ä–∏ —É—Å–ø—ñ—Ö—É ‚Üí —Å–µ—Ä–≤–µ—Ä **—Å–∞–º –≥–µ–Ω–µ—Ä—É—î –Ω–æ–≤—É —Ä–µ–≤—ñ–∑—ñ—é** (–Ω–µ –¥–æ–≤—ñ—Ä—è—î –∫–ª—ñ—î–Ω—Ç—É)
   - –ù–æ–≤–∞ —Ä–µ–≤—ñ–∑—ñ—è = `Date.now()` (–∞–±–æ `oldRevision + 1` —è–∫—â–æ timestamp –Ω–µ –∑–±—ñ–ª—å—à–∏–≤—Å—è)
   - –¶–µ –∑–∞—Ö–∏—â–∞—î –≤—ñ–¥ –ø—Ä–æ–ø—É—Å–∫—ñ–≤ —Ä–µ–≤—ñ–∑—ñ–π —Ç–∞ –≥–æ–Ω–æ–∫

### –í–∞–∂–ª–∏–≤–æ

- ‚ùó –°–µ—Ä–≤–µ—Ä **–ù–Ü–ö–û–õ–ò** –Ω–µ –ø—Ä–∏–π–º–∞—î —Ä–µ–≤—ñ–∑—ñ—é –≤—ñ–¥ –∫–ª—ñ—î–Ω—Ç–∞ —è–∫ –Ω–æ–≤—É
- ‚ùó –°–µ—Ä–≤–µ—Ä –∑–∞–≤–∂–¥–∏ —Å–∞–º —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ç—å —Ä–µ–≤—ñ–∑—ñ—é –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Å—Ç–∞—Ä–æ—ó –∑ –ë–î
- ‚ùó –†–µ–≤—ñ–∑—ñ—è —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ç—å—Å—è **—Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ —É—Å–ø—ñ—à–Ω–æ–º—É –∑–∞–ø–∏—Å—ñ** (–ø—ñ—Å–ª—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó —Ç–∞ –∑–∞–ø–∏—Å—É –≤ –ë–î)
- ‚ùó –ü—Ä–∏ 409 –∫–ª—ñ—î–Ω—Ç –º–∞—î –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –∑ —Å–µ—Ä–≤–µ—Ä–∞ (–ù–ï —Ä–æ–±–∏—Ç—å force overwrite)
- ‚ùó **100% –∞—Ç–æ–º–∞—Ä–Ω—ñ—Å—Ç—å**: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —É–º–æ–≤–Ω–∏–π UPDATE –Ω–∞ —Ä—ñ–≤–Ω—ñ –ë–î
  - `UPDATE ... WHERE id = ? AND (heroJson->>'heroRevision')::bigint = expectedRevision`
  - –Ø–∫—â–æ `count = 0` ‚Üí —Ä–µ–≤—ñ–∑—ñ—è –∑–º—ñ–Ω–∏–ª–∞—Å—è ‚Üí 409 Conflict
  - –Ø–∫—â–æ `count = 1` ‚Üí —É—Å–ø—ñ—Ö ‚Üí —Å–µ—Ä–≤–µ—Ä —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏–≤ —Ä–µ–≤—ñ–∑—ñ—é –≤ —Ü—å–æ–º—É –∂ UPDATE
  - –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –∑ `SELECT FOR UPDATE` –¥–ª—è –±–ª–æ–∫—É–≤–∞–Ω–Ω—è —Ä—è–¥–∫–∞
  - –¶–µ –≤–∏—Ä—ñ—à—É—î –≥–æ–Ω–∫–∏ –±–µ–∑ "–≤—ñ–∫–Ω–∞" –º—ñ–∂ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é —ñ –∑–∞–ø–∏—Å–æ–º

<hr style="border: none; border-top: 2px dotted #C9B36B; margin: 20px 0;">

## üîÑ –ü–æ–ª—ñ—Ç–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó localStorage ‚Üî server

### –ü—Ä–∞–≤–∏–ª–∞ –≤–∏—Ä—ñ—à–µ–Ω–Ω—è –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤

#### 1. –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –Ω–æ–≤—ñ—à–æ—ó –≤–µ—Ä—Å—ñ—ó

**–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 1: heroRevision (–Ω–∞–π—Ç–æ—á–Ω—ñ—à–∏–π)**
- –Ø–∫—â–æ `serverRevision > localRevision` ‚Üí server –Ω–æ–≤—ñ—à–∏–π
- –Ø–∫—â–æ `localRevision > serverRevision` ‚Üí local –Ω–æ–≤—ñ—à–∏–π
- –Ø–∫—â–æ —Ä—ñ–≤–Ω—ñ ‚Üí –Ω–µ–º–∞—î –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É

**–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 2: updatedAt (fallback)**
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ä–µ–≤—ñ–∑—ñ–π –Ω–µ–º–∞—î
- –†—ñ–∑–Ω–∏—Ü—è > 1 —Å–µ–∫—É–Ω–¥–∏ = –∫–æ–Ω—Ñ–ª—ñ–∫—Ç

#### 2. –í–∏—Ä—ñ—à–µ–Ω–Ω—è –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤

**–ü—Ä–∞–≤–∏–ª–æ –±–µ–∑–ø–µ–∫–∏: Server –∑–∞–≤–∂–¥–∏ –ø–µ—Ä–µ–º–∞–≥–∞—î (last-write-wins)**

- ‚úÖ `serverRevision > localRevision` ‚Üí –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ server
- ‚ö†Ô∏è `localRevision > serverRevision` ‚Üí **–∑–±–µ—Ä—ñ–≥–∞—î–º–æ local —è–∫ backup**, –∞–ª–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ server
- ‚úÖ –†—ñ–≤–Ω—ñ —Ä–µ–≤—ñ–∑—ñ—ó ‚Üí –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ server (—è–∫—â–æ `updatedAt` —Ä—ñ–∑–Ω–∏–π, server –ø–µ—Ä–µ–º–∞–≥–∞—î)

**–ß–æ–º—É server –∑–∞–≤–∂–¥–∏ –ø–µ—Ä–µ–º–∞–≥–∞—î:**
1. –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –∫–æ—Ä—É–ø—Ü—ñ—ó localStorage
2. –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ "—Ñ–µ–π–∫–æ–≤–∏—Ö" –ª–æ–∫–∞–ª—å–Ω–∏—Ö —Ä–µ–≤—ñ–∑—ñ–π –ø—ñ—Å–ª—è –±–∞–≥—ñ–≤
3. Server = single source of truth
4. –ó–º—ñ–Ω–∏ –≤ –æ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º—ñ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è (–ø–æ—Ç—Ä—ñ–±–µ–Ω —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è)

#### 3. Backup –ª–æ–∫–∞–ª—å–Ω–∏—Ö –≤–µ—Ä—Å—ñ–π

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è backup:**
- –Ø–∫—â–æ `localRevision > serverRevision` ‚Üí local –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —è–∫ backup
- Backup –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ `localStorage['hero_backups']`
- –ó–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –º–∞–∫—Å–∏–º—É–º 5 –æ—Å—Ç–∞–Ω–Ω—ñ—Ö backup-—ñ–≤ (FIFO - –Ω–∞–π—Å—Ç–∞—Ä—ñ—à—ñ –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è)
- Backup –º—ñ—Å—Ç–∏—Ç—å –¥–æ—Å—Ç–∞—Ç–Ω—ñ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:
  - `hero` - –ø–æ–≤–Ω–∏–π –æ–±'—î–∫—Ç –≥–µ—Ä–æ—è
  - `conflict` - —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç
  - `savedAt` - timestamp –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
  - `characterId` - ID –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
  - `heroRevision` - –ª–æ–∫–∞–ª—å–Ω–∞ —Ä–µ–≤—ñ–∑—ñ—è
  - `updatedAt` - –ª–æ–∫–∞–ª—å–Ω–∏–π timestamp
  - `serverRevision` - —Å–µ—Ä–≤–µ—Ä–Ω–∞ —Ä–µ–≤—ñ–∑—ñ—è
  - `serverUpdatedAt` - —Å–µ—Ä–≤–µ—Ä–Ω–∏–π timestamp

**–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∑ backup:**
- Backup –º–æ–∂–Ω–∞ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –≤—Ä—É—á–Ω—É (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
- Backup –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É)

<hr style="border: none; border-top: 2px dotted #C9B36B; margin: 20px 0;">

## ‚úÖ –í–∞–ª—ñ–¥–∞—Ü—ñ—è heroJson

### –î–µ –∑–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è

1. ‚úÖ **PUT `/characters/:id`** - –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ heroJson
2. ‚úÖ **–ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –≥–µ—Ä–æ—è** - heroJson –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è —è–∫ `{}` (–≤–∞–ª—ñ–¥–∞—Ü—ñ—è –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–∞)
3. ‚ö†Ô∏è **–ü—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –∑ –ë–î** - –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è (–¥–ª—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ)
   - –Ø–∫—â–æ –¥–∞–Ω—ñ –∑–ª–∞–º–∞–Ω—ñ - –∫–ª—ñ—î–Ω—Ç –º–æ–∂–µ —ó—Ö –≤–∏–ø—Ä–∞–≤–∏—Ç–∏ –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ

### –©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è

- –û–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è: `name`, `race`, `classId`
- –¢–∏–ø–∏: `level` (number >= 1), `exp` (number)
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏: `inventory` (array), `skills` (array), `equipment` (object)

### –ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –≥–µ—Ä–æ—è

- –ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ `heroJson = {}` (–≤–∞–ª—ñ–¥–∞—Ü—ñ—è –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–∞)
- –ü—ñ—Å–ª—è –ø–µ—Ä—à–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î heroJson –¥–æ –≤–∞–ª—ñ–¥–Ω–æ–≥–æ —Å—Ç–∞–Ω—É
- –ü–µ—Ä—à–∏–π save –∑–∞–≤–∂–¥–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –≤–∞–ª—ñ–¥–∞—Ü—ñ—é

### –õ–æ–≥—É–≤–∞–Ω–Ω—è

- –ü–æ–º–∏–ª–∫–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –ª–æ–≥—É—é—Ç—å—Å—è –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º: `accountId`, `characterId`, `revision`
- –î–µ—Ç–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–º–∏–ª–æ–∫ –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –∫–ª—ñ—î–Ω—Ç—É

<hr style="border: none; border-top: 2px dotted #C9B36B; margin: 20px 0;">

## üö¶ Rate Limiting

### –û–±–º–µ–∂–µ–Ω–Ω—è

- `/auth/login` - 5 —Å–ø—Ä–æ–±/—Ö–≤–∏–ª–∏–Ω—É (–ø–æ IP –∞–±–æ accountId)
- `/auth/register` - 3 —Å–ø—Ä–æ–±–∏/—Ö–≤–∏–ª–∏–Ω—É (–ø–æ IP)
- `/chat/messages` (POST) - 10 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å/—Ö–≤–∏–ª–∏–Ω—É (–ø–æ accountId)
- `/letters` (POST) - 5 –ª–∏—Å—Ç—ñ–≤/—Ö–≤–∏–ª–∏–Ω—É (–ø–æ accountId)
- `/characters/:id` (PUT) - 30 –æ–Ω–æ–≤–ª–µ–Ω—å/—Ö–≤–∏–ª–∏–Ω—É (–ø–æ accountId)

### –í—ñ–¥–ø–æ–≤—ñ–¥—å –ø—Ä–∏ –ø–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—ñ

**HTTP 429 Too Many Requests:**
```json
{
  "error": "rate_limit_exceeded",
  "message": "Too many requests. Please try again later.",
  "retryAfter": 45,
  "resetAt": "2025-01-19T12:01:00.000Z"
}
```

**Headers:**
- `Retry-After: 45` (—Å–µ–∫—É–Ω–¥–∏ –¥–æ —Å–∫–∏–¥–∞–Ω–Ω—è)
- `X-RateLimit-Limit: 10` (–º–∞–∫—Å–∏–º—É–º –∑–∞–ø–∏—Ç—ñ–≤)
- `X-RateLimit-Remaining: 0` (–∑–∞–ª–∏—à–∏–ª–æ—Å—å)
- `X-RateLimit-Reset: 2025-01-19T12:01:00.000Z` (—á–∞—Å —Å–∫–∏–¥–∞–Ω–Ω—è)

<hr style="border: none; border-top: 2px dotted #C9B36B; margin: 20px 0;">

## ‚è∞ lastActivityAt

### –ö–æ–ª–∏ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è

1. ‚úÖ **–ü—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ `heroJson`** (PUT `/characters/:id` –∑ `heroJson`)
2. ‚úÖ **–ü—Ä–∏ heartbeat** (POST `/characters/heartbeat`)
3. ‚úÖ **–ü—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ —á–∞—Ç—É** (POST `/chat/messages`)
4. ‚ùå **–ù–ï –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è** –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ –æ–∫—Ä–µ–º–∏—Ö –ø–æ–ª—ñ–≤ (`level`, `exp`, —Ç–æ—â–æ) –±–µ–∑ `heroJson`

### –õ–æ–≥—ñ–∫–∞

- `lastActivityAt` = —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä "–∂–∏–≤–æ—ó" –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –≥—Ä–∞–≤—Ü—è
- –û–Ω–æ–≤–ª—é—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ "–∑–Ω–∞—á—É—â–∏—Ö" –¥—ñ—è—Ö, –Ω–µ –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É autosave
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –æ–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å—É (–∞–∫—Ç–∏–≤–Ω—ñ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 10 —Ö–≤–∏–ª–∏–Ω)

<hr style="border: none; border-top: 2px dotted #C9B36B; margin: 20px 0;">

## üîí Side-effect Endpoints (/heal, /buff)

### –ö–æ–Ω—Ç—Ä–∞–∫—Ç

**Endpoints, —è–∫—ñ –∑–º—ñ–Ω—é—é—Ç—å heroJson:**
- `POST /characters/:id/heal` - –ª—ñ–∫—É–≤–∞–Ω–Ω—è
- `POST /characters/:id/buff` - –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –±–∞—Ñ—É

**–ü—Ä–∞–≤–∏–ª–∞:**
- ‚ùó **–ó–∞–≤–∂–¥–∏ —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç—è—Ç—å —Ä–µ–≤—ñ–∑—ñ—é** –ø—Ä–∏ –∑–º—ñ–Ω—ñ heroJson
- ‚ùó –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å optimistic locking (—Ü–µ side-effect endpoints)
- ‚ùó –û–Ω–æ–≤–ª—é—é—Ç—å `heroJsonVersion` —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
- ‚ùó –õ–æ–≥—É—é—Ç—å –∑–º—ñ–Ω–∏ –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è

**–ß–æ–º—É:**
- –¶–µ "side-effect" endpoints - –≤–æ–Ω–∏ –∑–º—ñ–Ω—é—é—Ç—å —Å—Ç–∞–Ω –≥–µ—Ä–æ—è
- –Ü–Ω–∫—Ä–µ–º–µ–Ω—Ç —Ä–µ–≤—ñ–∑—ñ—ó –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ –Ω–∞—Å—Ç—É–ø–Ω–∏–π PUT –∑ optimistic locking –≤–∏—è–≤–∏—Ç—å –∫–æ–Ω—Ñ–ª—ñ–∫—Ç
- –ó–∞—Ö–∏—â–∞—î –≤—ñ–¥ –≤—Ç—Ä–∞—Ç–∏ –∑–º—ñ–Ω –ø—Ä–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ—è—Ö

<hr style="border: none; border-top: 2px dotted #C9B36B; margin: 20px 0;">

## ‚ö†Ô∏è –ü–æ–≤–µ–¥—ñ–Ω–∫–∞ –∫–ª—ñ—î–Ω—Ç–∞ –ø—Ä–∏ 409

### –ü—Ä–∞–≤–∏–ª–∞

1. ‚ùó **–ù–ï —Ä–æ–±–∏—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π force overwrite**
2. ‚ùó **–ó–±–µ—Ä—ñ–≥–∞—Ç–∏ –ª–æ–∫–∞–ª—å–Ω—É –≤–µ—Ä—Å—ñ—é —è–∫ backup** –ø–µ—Ä–µ–¥ –∑–∞–º—ñ–Ω–æ—é
3. ‚ùó **–í–∏–º–∞–≥–∞—Ç–∏ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è** –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
4. ‚ùó **–ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è** –ø—Ä–æ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç

### –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è

```typescript
try {
  await updateCharacter(id, { heroJson, expectedRevision });
} catch (error) {
  if (error.status === 409) {
    // 1. –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ª–æ–∫–∞–ª—å–Ω—É –≤–µ—Ä—Å—ñ—é —è–∫ backup
    saveLocalBackup(localHero, conflict);
    
    // 2. –ù–ï —Ä–æ–±–∏–º–æ force overwrite
    // 3. –í–∏–º–∞–≥–∞—î–º–æ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    throw new Error('Character was modified. Please reload the page.');
  }
}
```

<hr style="border: none; border-top: 2px dotted #C9B36B; margin: 20px 0;">

## üìù –ü—Ä–∏–∫–ª–∞–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### Optimistic Locking

```typescript
// –ö–ª—ñ—î–Ω—Ç –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –≥–µ—Ä–æ—è
const character = await getCharacter(id);
const hero = character.heroJson;
const currentRevision = hero.heroRevision; // –∑–±–µ—Ä—ñ–≥–∞—î–º–æ

// –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ä–æ–±–∏—Ç—å –∑–º—ñ–Ω–∏
hero.adena += 100;

// –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∑ –æ—á—ñ–∫—É–≤–∞–Ω–æ—é —Ä–µ–≤—ñ–∑—ñ—î—é
try {
  await updateCharacter(id, {
    heroJson: hero,
    expectedRevision: currentRevision, // –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É
  });
} catch (error) {
  if (error.status === 409) {
    // –ö–æ–Ω—Ñ–ª—ñ–∫—Ç! –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ
    const serverState = error.details?.serverState;
    console.log('Server revision:', serverState?.heroRevision);
    // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≥–µ—Ä–æ—è –∑ —Å–µ—Ä–≤–µ—Ä–∞
    window.location.reload();
  }
}
```

### Sync Conflict

```typescript
// –ü—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è –∫–æ–Ω—Ñ–ª—ñ–∫—Ç
const serverCharacter = await getCharacter(id);
const localHero = loadHero();

const conflict = checkSyncConflict(serverCharacter, localHero);
if (conflict.hasConflict) {
  if (conflict.localNewer) {
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ local —è–∫ backup
    saveLocalBackup(localHero, conflict);
  }
  // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ server –≤–µ—Ä—Å—ñ—é
  return serverCharacter.heroJson;
}
```

<hr style="border: none; border-top: 2px dotted #C9B36B; margin: 20px 0;">

**–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è:** 2025-01-19  
**–í–µ—Ä—Å—ñ—è:** 1.0
