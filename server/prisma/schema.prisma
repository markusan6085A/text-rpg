generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id           String   @id @default(cuid())
  login        String   @unique
  passHash     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  characters   Character[]
}

model Character {
  id           String   @id @default(cuid())
  accountId    String
  name         String
  race         String
  classId      String
  sex          String

  level        Int      @default(1)
  exp          BigInt   @default(0)
  sp           Int      @default(0)

  adena        Int      @default(0)
  aa           Int      @default(0)  // Ancient Adena
  coinLuck     Int      @default(0)

  // –û–¥–∏–Ω JSON –ø—ñ–¥ "–≥–µ—Ä–æ—è" (—Å—Ç–∞—Ç—ñ, hp/mp/cp, –±–∞—Ñ–∏, –ø–æ–∑–∏—Ü—ñ—è, —â–æ –∑–∞–≤–≥–æ–¥–Ω–æ)
  heroJson     Json     @default("{}")

  // ‚úÖ –î–æ–¥–∞—î–º–æ –æ–∫—Ä–µ–º–æ –∫–æ–ª—ñ—Ä –Ω—ñ–∫—É, —â–æ–± –Ω–µ —Ç—è–≥–Ω—É—Ç–∏ heroJson –≤ –ø–æ—à—Ç—ñ/—á–∞—Ç—ñ
  nickColor    String?

  // üî• –í—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –¥–ª—è –æ–Ω–ª–∞–π–Ω
  lastActivityAt DateTime @default(now()) @updatedAt

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  account      Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  inventory    InventoryItem[]
  chatMessages ChatMessage[]
  lettersFrom  Letter[] @relation("LettersFrom")
  lettersTo    Letter[] @relation("LettersTo")
  news         News[]   @relation("News")
  sevenSealsMedals SevenSealsMedal[]
  createdClan  Clan?    @relation("ClanCreator")
  clanMember   ClanMember?
  clanChatMessages ClanChat[]
  clanLogs     ClanLog[]

  @@index([accountId])
  @@index([lastActivityAt]) // –Ü–Ω–¥–µ–∫—Å –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –ø–æ—à—É–∫—É –æ–Ω–ª–∞–π–Ω –≥—Ä–∞–≤—Ü—ñ–≤
  @@unique([accountId, name])
}

model InventoryItem {
  id           String   @id @default(cuid())
  characterId  String

  itemId       String   // —Ç–≤—ñ–π –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π id —Ç–∏–ø—É "weapon_demon_c"
  qty          Int      @default(1)
  equippedSlot String?  // "weapon" | "shield" | "head" ...
  meta         Json     @default("{}") // –∑–∞—Ç–æ—á–∫–∞, –µ–ª–µ–º–µ–Ω—Ç–∏, –∫–∞—Å—Ç–æ–º–Ω—ñ –ø–æ–ª—è

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  character    Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId])
  @@index([characterId, itemId])
}

model Kv {
  key        String   @id
  value      String
  updatedAt  DateTime @updatedAt
}

model ChatMessage {
  id          String   @id @default(cuid())
  characterId String
  channel     String   @default("general") // "general", "trade", "clan", "private"
  message     String
  createdAt   DateTime @default(now())

  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([channel, createdAt])
  @@index([characterId])
}

model Letter {
  id          String   @id @default(cuid())
  fromCharacterId String
  toCharacterId   String
  subject     String   @default("")
  message     String
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  readAt      DateTime?

  fromCharacter Character @relation("LettersFrom", fields: [fromCharacterId], references: [id], onDelete: Cascade)
  toCharacter   Character @relation("LettersTo", fields: [toCharacterId], references: [id], onDelete: Cascade)

  @@index([toCharacterId, isRead, createdAt])
  @@index([fromCharacterId])

  // ‚úÖ –î–ª—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ (OR: A->B –∞–±–æ B->A) + orderBy createdAt
  @@index([fromCharacterId, toCharacterId, createdAt])
  @@index([toCharacterId, fromCharacterId, createdAt])
}

model News {
  id           String   @id @default(cuid())
  type         String   // "new_player" | "premium_purchase" | "raid_boss_kill"
  characterId  String?  // ID –≥—Ä–∞–≤—Ü—è (nullable –¥–ª—è new_player)
  characterName String? // –ù—ñ–∫ –≥—Ä–∞–≤—Ü—è
  metadata     Json     @default("{}") // –î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è: { hours?: number, bossName?: string, bossLevel?: number, bossDrops?: any[] }
  createdAt    DateTime @default(now())

  character    Character? @relation("News", fields: [characterId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([type])
}

model SevenSealsMedal {
  id          String   @id @default(cuid())
  characterId String
  weekStart   DateTime // –ü–æ—á–∞—Ç–æ–∫ —Ç–∏–∂–Ω—è (–ø–æ–Ω–µ–¥—ñ–ª–æ–∫) –¥–ª—è –≥—Ä—É–ø—É–≤–∞–Ω–Ω—è
  createdAt   DateTime @default(now())

  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId, weekStart])
  @@index([weekStart])
}

model Clan {
  id          String   @id @default(cuid())
  name        String   @unique // –ù–∞–∑–≤–∞ –∫–ª–∞–Ω—É (—É–Ω—ñ–∫–∞–ª—å–Ω–∞)
  level       Int      @default(1)
  reputation  Int      @default(0) // –†–µ–ø—É—Ç–∞—Ü—ñ—è –∫–ª–∞–Ω—É
  adena       Int      @default(0) // –ê–¥–µ–Ω–∞ –∫–ª–∞–Ω—É
  coinLuck    Int      @default(0) // Coin of Luck –∫–ª–∞–Ω—É
  creatorId   String   @unique // ID –≥—Ä–∞–≤—Ü—è, —è–∫–∏–π —Å—Ç–≤–æ—Ä–∏–≤ –∫–ª–∞–Ω (–æ–¥–∏–Ω –≥—Ä–∞–≤–µ—Ü—å = –æ–¥–∏–Ω –∫–ª–∞–Ω)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creator     Character @relation("ClanCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  members     ClanMember[]
  chatMessages ClanChat[]
  logs        ClanLog[]
  warehouse   ClanWarehouse[]

  @@index([creatorId])
  @@index([name])
}

model ClanMember {
  id          String   @id @default(cuid())
  clanId      String
  characterId String   @unique // –û–¥–∏–Ω –≥—Ä–∞–≤–µ—Ü—å –º–æ–∂–µ –±—É—Ç–∏ —Ç—ñ–ª—å–∫–∏ –≤ –æ–¥–Ω–æ–º—É –∫–ª–∞–Ω—ñ
  title       String?  // –¢–∏—Ç—É–ª –≥—Ä–∞–≤—Ü—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "–¢–æ–ø")
  isDeputy    Boolean  @default(false) // –ó–∞–º—ñ—Å–Ω–∏–∫ –≥–ª–∞–≤–∏
  joinedAt    DateTime @default(now())

  clan        Clan      @relation(fields: [clanId], references: [id], onDelete: Cascade)
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([clanId])
  @@index([characterId])
}

model ClanChat {
  id          String   @id @default(cuid())
  clanId      String
  characterId String
  message     String
  createdAt   DateTime @default(now())

  clan        Clan      @relation(fields: [clanId], references: [id], onDelete: Cascade)
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([clanId, createdAt])
  @@index([characterId])
}

model ClanLog {
  id          String   @id @default(cuid())
  clanId      String
  type        String   // "member_joined", "member_left", "member_kicked", "item_deposited", "item_withdrawn", "title_changed", "deputy_appointed", "deputy_removed"
  characterId String?  // ID –≥—Ä–∞–≤—Ü—è, —è–∫–∏–π –≤–∏–∫–æ–Ω–∞–≤ –¥—ñ—é (nullable –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–∏—Ö –ø–æ–¥—ñ–π)
  targetCharacterId String? // ID —Ü—ñ–ª—å–æ–≤–æ–≥–æ –≥—Ä–∞–≤—Ü—è (–¥–ª—è kicked, title_changed, etc.)
  message     String   // –¢–µ–∫—Å—Ç –ª–æ–≥—É
  metadata    Json     @default("{}") // –î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è
  createdAt   DateTime @default(now())

  clan        Clan      @relation(fields: [clanId], references: [id], onDelete: Cascade)
  character   Character? @relation(fields: [characterId], references: [id], onDelete: SetNull)

  @@index([clanId, createdAt])
  @@index([characterId])
}

model ClanWarehouse {
  id          String   @id @default(cuid())
  clanId      String
  itemId      String   // ID –ø—Ä–µ–¥–º–µ—Ç–∞
  qty         Int      @default(1)
  meta        Json     @default("{}") // –ú–µ—Ç–∞–¥–∞–Ω—ñ –ø—Ä–µ–¥–º–µ—Ç–∞
  depositedBy String?  // ID –≥—Ä–∞–≤—Ü—è, —è–∫–∏–π –ø–æ–∫–ª–∞–≤ –ø—Ä–µ–¥–º–µ—Ç
  depositedAt DateTime @default(now())

  clan        Clan     @relation(fields: [clanId], references: [id], onDelete: Cascade)

  @@index([clanId])
  @@index([clanId, depositedAt])
}