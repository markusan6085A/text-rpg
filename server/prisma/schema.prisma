generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id           String   @id @default(cuid())
  login        String   @unique
  passHash     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  characters   Character[]
}

model Character {
  id           String   @id @default(cuid())
  accountId    String
  name         String
  race         String
  classId      String
  sex          String

  level        Int      @default(1)
  exp          BigInt   @default(0)
  sp           Int      @default(0)

  adena        Int      @default(0)
  aa           Int      @default(0)  // Ancient Adena
  coinLuck     Int      @default(0)

  // –û–¥–∏–Ω JSON –ø—ñ–¥ "–≥–µ—Ä–æ—è" (—Å—Ç–∞—Ç—ñ, hp/mp/cp, –±–∞—Ñ–∏, –ø–æ–∑–∏—Ü—ñ—è, —â–æ –∑–∞–≤–≥–æ–¥–Ω–æ)
  heroJson     Json     @default("{}")

  // üî• –í—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –¥–ª—è –æ–Ω–ª–∞–π–Ω
  lastActivityAt DateTime @default(now()) @updatedAt

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  account      Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  inventory    InventoryItem[]
  chatMessages ChatMessage[]
  lettersFrom  Letter[] @relation("LettersFrom")
  lettersTo    Letter[] @relation("LettersTo")
  news         News[]   @relation("News")

  @@index([accountId])
  @@index([lastActivityAt]) // –Ü–Ω–¥–µ–∫—Å –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –ø–æ—à—É–∫—É –æ–Ω–ª–∞–π–Ω –≥—Ä–∞–≤—Ü—ñ–≤
  @@unique([accountId, name])
}

model InventoryItem {
  id           String   @id @default(cuid())
  characterId  String

  itemId       String   // —Ç–≤—ñ–π –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π id —Ç–∏–ø—É "weapon_demon_c"
  qty          Int      @default(1)
  equippedSlot String?  // "weapon" | "shield" | "head" ...
  meta         Json     @default("{}") // –∑–∞—Ç–æ—á–∫–∞, –µ–ª–µ–º–µ–Ω—Ç–∏, –∫–∞—Å—Ç–æ–º–Ω—ñ –ø–æ–ª—è

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  character    Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId])
  @@index([characterId, itemId])
}

model Kv {
  key        String   @id
  value      String
  updatedAt  DateTime @updatedAt
}

model ChatMessage {
  id          String   @id @default(cuid())
  characterId String
  channel     String   @default("general") // "general", "trade", "clan", "private"
  message     String
  createdAt   DateTime @default(now())

  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([channel, createdAt])
  @@index([characterId])
}

model Letter {
  id          String   @id @default(cuid())
  fromCharacterId String
  toCharacterId   String
  subject     String   @default("")
  message     String
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  readAt      DateTime?

  fromCharacter Character @relation("LettersFrom", fields: [fromCharacterId], references: [id], onDelete: Cascade)
  toCharacter   Character @relation("LettersTo", fields: [toCharacterId], references: [id], onDelete: Cascade)

  @@index([toCharacterId, isRead, createdAt])
  @@index([fromCharacterId])
}

model News {
  id           String   @id @default(cuid())
  type         String   // "new_player" | "premium_purchase" | "raid_boss_kill"
  characterId  String?  // ID –≥—Ä–∞–≤—Ü—è (nullable –¥–ª—è new_player)
  characterName String? // –ù—ñ–∫ –≥—Ä–∞–≤—Ü—è
  metadata     Json     @default("{}") // –î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è: { hours?: number, bossName?: string, bossLevel?: number, bossDrops?: any[] }
  createdAt    DateTime @default(now())

  character    Character? @relation("News", fields: [characterId], references: [id], onDelete: SetNull)

  @@index([createdAt])
  @@index([type])
}