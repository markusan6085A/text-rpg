#!/bin/bash

# üöÄ –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—é text-rpg –Ω–∞ VPS
# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: ./deploy.sh

set -e  # –ó—É–ø–∏–Ω–∏—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ

# –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è –≤–∏–≤–æ–¥—É
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}üöÄ –ü–æ—á–∞—Ç–æ–∫ –¥–µ–ø–ª–æ—é text-rpg...${NC}"

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –∑–Ω–∞—Ö–æ–¥–∏–º–æ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó
if [ ! -f "package.json" ]; then
    echo -e "${RED}‚ùå –ü–æ–º–∏–ª–∫–∞: package.json –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –ó–∞–ø—É—Å—Ç—ñ—Ç—å —Å–∫—Ä–∏–ø—Ç –∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó server/${NC}"
    exit 1
fi

# –û—Ç—Ä–∏–º–∞—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ –∑–º—ñ–Ω–∏ –∑ GitHub (—è–∫—â–æ —Ü–µ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π)
if [ -d ".git" ]; then
    echo -e "${GREEN}üì• –û—Ç—Ä–∏–º–∞–Ω–Ω—è –∑–º—ñ–Ω –∑ GitHub...${NC}"
    git pull origin main || git pull origin master || echo -e "${YELLOW}‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑–º—ñ–Ω–∏ –∑ GitHub (–º–æ–∂–µ –±—É—Ç–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)${NC}"
fi

# –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
echo -e "${GREEN}üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π...${NC}"
npm install

# –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ Prisma Client
echo -e "${GREEN}üîß –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è Prisma Client...${NC}"
npm run prisma:generate

# –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—ó (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
echo -e "${GREEN}üóÑÔ∏è –ó–∞–ø—É—Å–∫ –º—ñ–≥—Ä–∞—Ü—ñ–π...${NC}"
npm run prisma:migrate:deploy || echo -e "${YELLOW}‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –º—ñ–≥—Ä–∞—Ü—ñ–π (–º–æ–∂–µ –±—É—Ç–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, —è–∫—â–æ –≤–∂–µ –≤–∏–∫–æ–Ω–∞–Ω–æ)${NC}"

# –ó—ñ–±—Ä–∞—Ç–∏ –ø—Ä–æ–µ–∫—Ç
echo -e "${GREEN}üî® –ó–±—ñ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç—É...${NC}"
npm run build

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ —ñ—Å–Ω—É—î dist/index.js
if [ ! -f "dist/index.js" ]; then
    echo -e "${RED}‚ùå –ü–æ–º–∏–ª–∫–∞: dist/index.js –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø—ñ—Å–ª—è –∑–±—ñ—Ä–∫–∏${NC}"
    exit 1
fi

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ PM2
echo -e "${GREEN}üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2...${NC}"
if pm2 list | grep -q "text-rpg"; then
    pm2 restart text-rpg
else
    pm2 start dist/index.js --name text-rpg
fi

# –ü–æ–∫–∞–∑–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å
echo -e "${GREEN}‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ!${NC}"
echo -e "${GREEN}üìä –°—Ç–∞—Ç—É—Å PM2:${NC}"
pm2 status

echo -e "${GREEN}üìù –õ–æ–≥–∏ (–æ—Å—Ç–∞–Ω–Ω—ñ 20 —Ä—è–¥–∫—ñ–≤):${NC}"
pm2 logs text-rpg --lines 20 --nostream
